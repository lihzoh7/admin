<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SPACE GLASS â€“ Admin Winners</title>

<style>
body {
  margin:0;
  font-family:Arial, sans-serif;
  background:#020b2d;
  color:white;
}

/* NAV */
.admin-tabs {
  display:flex;
  gap:20px;
  padding:15px;
  background:#010821;
}
.admin-tabs div {
  cursor:pointer;
  padding:8px 16px;
  border-radius:6px;
}
.admin-tabs div.active,
.admin-tabs div:hover {
  background:#1b2a6b;
}

/* CONTENT */
#content {
  padding:20px;
}

.session {
  margin-bottom:30px;
  border-left:4px solid #7FDBFF;
  padding-left:15px;
}

.session h3 {
  margin-bottom:10px;
  color:#7FDBFF;
}

.row {
  display:grid;
  grid-template-columns: 40px 1fr 1fr 1fr;
  gap:10px;
  padding:6px 0;
  border-bottom:1px solid #333;
}

.medal {
  font-size:18px;
}
</style>
</head>

<body>

<!-- ADMIN NAV -->
<div class="admin-tabs">
  <div onclick="location.href='admin-messages.html'">Messages</div>
  <div onclick="location.href='admin-players.html'">Players</div>
  <div onclick="location.href='admin-queries.html'">Queries</div>
  <div class="active">Winners</div>
  <div onclick="alert('Open admin-lives.html')">Lives</div>
</div>

<div id="content">
  <h2>Game Winners</h2>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqJTLjxhZBCsvjrTH_cG0fkXlElG6BqTg",
  authDomain: "tose-ccf8f.firebaseapp.com",
  databaseURL: "https://tose-ccf8f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tose-ccf8f",
  storageBucket: "tose-ccf8f.firebasestorage.app",
  messagingSenderId: "475447495901",
  appId: "1:475447495901:web:9189276a162a3680afdf34"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const container = document.getElementById("content");

/*
EXPECTED STRUCTURE (EXAMPLE)
leaderboardHistory: {
  sessionId123: {
    endedAt: timestamp,
    prizePool: 1000,
    results: {
      uid1: { score: 9000 },
      uid2: { score: 8700 }
    }
  }
}
*/

async function loadWinners(){
  const snap = await get(ref(db,"leaderboardHistory"));
  const data = snap.val();
  if(!data){
    container.innerHTML += "<p>No completed games yet.</p>";
    return;
  }

  for(const sessionId in data){
    const session = data[sessionId];
    const ended = session.endedAt
      ? new Date(session.endedAt).toLocaleString()
      : "Unknown date";

    const prizePool = session.prizePool || 0;

    const section = document.createElement("div");
    section.className = "session";

    section.innerHTML = `<h3>Game Ended: ${ended} | Prize Pool: R${prizePool}</h3>`;

    let arr = [];
    for(const uid in session.results){
      arr.push({ uid, score: session.results[uid].score });
    }

    arr.sort((a,b)=>b.score - a.score);
    arr = arr.slice(0,20);

    for(let i=0;i<arr.length;i++){
      let medal = i===0 ? "ðŸ¥‡" : i===1 ? "ðŸ¥ˆ" : i===2 ? "ðŸ¥‰" : i+1;
      let percent = i===0 ? 0.65 : i===1 ? 0.25 : i===2 ? 0.10 : 0;
      let amount = percent ? (prizePool * percent).toFixed(2) : "-";

      let name = arr[i].uid;
      try {
        const userSnap = await get(ref(db,"users/"+arr[i].uid));
        if(userSnap.exists()){
          const u = userSnap.val();
          name = `${u.name || ""} ${u.surname || ""}`;
        }
      } catch(e){}

      const row = document.createElement("div");
      row.className = "row";

      row.innerHTML = `
        <div class="medal">${medal}</div>
        <div>${name}</div>
        <div>Score: ${arr[i].score}</div>
        <div>${amount !== "-" ? "R"+amount : ""}</div>
      `;
      section.appendChild(row);
    }

    container.appendChild(section);
  }
}

loadWinners();
</script>

</body>
</html>
